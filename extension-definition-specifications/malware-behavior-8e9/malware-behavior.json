{
    "$schema": "http://json-schema.org/draft-07/schema#",
    "$id": "https://raw.githubusercontent.com/oasis-open/cti-stix-common-objects/main/extension-definition-specifications/malware-behavior/malware-behavior.json",
    "title": "malware-behavior",
    "description": "malware-behavior SDO",
    "type": "object",
    "allOf": [
	{
	    "$ref": "https://raw.githubusercontent.com/oasis-open/cti-stix2-json-schemas/stix2.1/schemas/common/core.json"
	},
	{
	    "properties": {
		"type": {
		    "type": "string",
		    "description": "The value of this property MUST be malware-behavior.",
		    "enum": [
			"malware-behavior"
		    ]
		},
		"id": {
		    "title": "id",
		    "pattern": "^malware-behavior--"
		},
		"name": {
		    "type": "string",
		    "description": "The name of the behavior (e.g., Request Email Address List)."
		},
		"obj_defn": {
		    "$ref": "https://raw.githubusercontent.com/oasis-open/cti-stix-common-objects/main/extension-definition-specifications/malware-behavior/object-definition.json"
		},
		"obj_version": {
		    "type": "string",
		    "description": "Specifies the version of the mailware-behavior object."
		},
		"related_object_refs": {
		    "description": "Related objects from other knowledge bases.",
		    "type": "array",
                    "items": {
                        "$ref": "http://raw.githubusercontent.com/oasis-open/cti-stix2-json-schemas/stix2.1/schemas/common/identifier.json"
                    },
                    "minItems": 1,
                    "$comment": "not required, but if used, there must be 1 item"
		},
		"tags": {
		    "$ref": "#/definitions/tags_dictionary",
		    "description": "The dictionary keys MUST be the tag names where the values are the value of the tag.",
		    "$comment": "not required, but if used, there must be 1 item"
		},
		"objective_refs": {
		    "description": "The malware-objective objects associated with the behavior.",
		    "type": "array",
                    "items": {
                        "allOf": [
			     {
				 "$ref": "http://raw.githubusercontent.com/oasis-open/cti-stix2-json-schemas/stix2.1/schemas/common/identifier.json"
			     },
			     {
				 "pattern": "^malware-objective--"
			     }
			 ]
                    },
                    "minItems": 1,
                    "$comment": "not required, but if used, there must be 1 item" 
		},
		"snippets": {
		    "description": "The code snippets associated with the behavior.",
		    "type": "array",
                    "items": {
                        "$ref": "#/definitions/snippet"
                    },
                    "minItems": 1,
                    "$comment": "not required, but if used, there must be 1 item"
		},
		"detection_rules": {
		    "description": "The ways to detect the behavior.",
		    "type": "array",
                    "items": {
                        "$ref": "#/definitions/detection_rule"
                    },
                    "minItems": 1,
                    "$comment": "not required, but if used, there must be 1 item"
		},
		"contibutor_refs": {
		    "description": "Contributor(s) to the behavior information.",
		    "type": "array",
                    "items": {
			 "allOf": [
			     {
				 "$ref": "http://raw.githubusercontent.com/oasis-open/cti-stix2-json-schemas/stix2.1/schemas/common/identifier.json"
			     },
			     {
				 "pattern": "^identity--"
			     }
			 ]
                    },
                    "minItems": 1,
                    "$comment": "not required, but if used, there must be 1 item" 
		}
	    },
	    "required": [
		"name",
		"obj_defn"
	    ]
	}
    ],
    "definitions": {
	"snippet": {
	    "properties": {
		"snippet": {
		    "type": "string",
		    "description": "The code snippet."
		},
		"exemplify_ref": {
		    "allOf": [
			{
			    "$ref": "http://raw.githubusercontent.com/oasis-open/cti-stix2-json-schemas/stix2.1/schemas/common/identifier.json"
			},
			{
			    "oneOf": [
				{
				    "pattern": "^malware-behavior--"
				},
				{
				    "pattern": "^malware-method--"
				}
			    ]
			}
		    ]
		},
		"language": {
		    "type": "string",
		    "description": "The language of the code snippet. The value of this property SHOULD come from the STIX 2.1 implementation-language-ov"
		},
		"description": {
		    "type": "string",
		    "description": "The description of the code snippet. Citations referencing external references MAY be included."
		},
		"references": {
		    "type": "array",
		    "item": {
			"$ref": "http://raw.githubusercontent.com/oasis-open/cti-stix2-json-schemas/stix2.1/schemas/common/external-reference.json"
		    },
		    "minItems": 1,
                    "$comment": "not required, but if used, there must be 1 item"
		},
		"author_ref": {
		    "description": "The id property of the identity object that describes the author of the snippet.",
		    "allOf": [
			{
			    "$ref": "http://raw.githubusercontent.com/oasis-open/cti-stix2-json-schemas/stix2.1/schemas/common/identifier.json"
			},
			{
			    "pattern": "^identity--"
			}
		    ]
		}
		
	    },
	    "required": [
		"snippet",
		"exemplify_ref"
	    ]		    
	},
	"detection_rule": {
	    "properties": {
		"rule_type": {
		    "type": "string",
		    "description": "The type of rule used to detect the behavior or method. The value of this property SHOULD come from detection-tool-ov" 
		},
		"rule_name": {
		    "type": "string",
		    "description": "The name of the rule or signature"
		},
		"rule": {
		    "type": "string",
		    "description": "The detection rule or signature. If this property is not populated, then the reference property MUST be populated."
		},
		"reference": {
		    "type": "string",
		    "description": "The value of the string SHOULD correspond to the external_id property of an external reference defined in the Behavior SDO."
		},
		"defect_ref": {
		    "allOf": [
			{
			    "$ref": "http://raw.githubusercontent.com/oasis-open/cti-stix2-json-schemas/stix2.1/schemas/common/identifier.json"
			},
			{
			    "oneOf": [
				{
				    "pattern": "^malware-behavior--"
				},
				{
				    "pattern": "^malware-method--"
				}
			    ]
			}
		    ]
		},
		"description": {
		    "type": "string",
		    "description": "The description of the rule, signature, or manual method."
		},
		"api_fncs": {
		    "description": "The Windows API functions associated with the rule or signature.",
		    "type": "array",
		    "item": {
			"type": "string"
		    },
		    "minItems": 1,
                    "$comment": "not required, but if used, there must be 1 item"
		}
	    },
	    "required": [
		"rule_type"
	    ]
	},
	"tags_dictionary": {
	    "allOf": [{ "$ref": "http://raw.githubusercontent.com/oasis-open/cti-stix2-json-schemas/stix2.1/schemas/common/dictionary.json" }],
	    "description": "Specifies tags and values.",
            "additionalProperties": true
	},
	"implementation-language-ov": {
	    "oneOf": [
		{
		    "type": "string",
		    "enum": [
			"asm",
			"cmd",
			"delphi",
			"masm"
		    ]
		},
		{
		    "$ref": "http://raw.githubusercontent.com/oasis-open/cti-stix2-json-schemas/stix2.1/schemas/sdos/malware.json#/definitions/implementation-language-ov"
		}
	    ]
	},
	"detection-tool-ov": {
	    "type": "string",
	    "enum": [
		"capa",
		"cape",
		"manual",
		"sigma",
		"yara"
	    ]
	}
    }	    
}
